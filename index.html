<!-- public/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
      <title>2-Player Obby</title>
        <style>
            html, body { margin:0; height:100%; background:#101014; font-family:system-ui, sans-serif; }
                #hud { position:fixed; top:12px; left:12px; color:#fff; z-index:10; background:rgba(255,255,255,0.08); backdrop-filter:blur(8px); padding:10px 12px; border-radius:10px; }
                    #hud b { color:#7cf; }
                        #centerBanner { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); color:#fff; background:rgba(0,0,0,0.5); padding:16px 22px; border-radius:12px; display:none; }
                            #resetBtn { margin-left:10px; }
                                canvas { display:block; }
                                  </style>
                                  </head>
                                  <body>
                                    <div id="hud">
                                        <div><b>Room:</b> <span id="roomId">—</span></div>
                                            <div><b>Players:</b> <span id="playerCount">0</span>/2</div>
                                                <div><b>Checkpoint:</b> <span id="checkpoint">0</span></div>
                                                    <button id="resetBtn">Reset</button>
                                                      </div>
                                                        <div id="centerBanner"></div>
                                                          <script type="module">
                                                              import * as THREE from "https://unpkg.com/three@0.160.0/build/three.module.js";
                                                                  import { OrbitControls } from "https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js";
                                                                      import io from "https://cdn.socket.io/4.7.2/socket.io.esm.min.js";
                                                                      
                                                                          // ===== CONFIG =====
                                                                              const SERVER_URL = "Railway/Fly.io"; // e.g., https://your-app.onrender.com
                                                                                  const PLAYER_SPEED = 9.5;
                                                                                      const JUMP_FORCE = 12.5;
                                                                                          const GRAVITY = 28;
                                                                                              const SYNC_RATE_MS = 50;
                                                                                                  const DISAPPEAR_INTERVAL = 1.4; // seconds on/off cycle
                                                                                                      const SPEED_PAD_MULT = 2.0;
                                                                                                      
                                                                                                          // ===== STATE =====
                                                                                                              const state = {
                                                                                                                    name: "Player" + Math.floor(Math.random()*1000),
                                                                                                                          checkpoint: 0,
                                                                                                                                grounded: false,
                                                                                                                                      vel: new THREE.Vector3(),
                                                                                                                                            inputs: { f:false, b:false, l:false, r:false, j:false },
                                                                                                                                                  gameOver: false
                                                                                                                                                      };
                                                                                                                                                      
                                                                                                                                                          // ===== SOCKET =====
                                                                                                                                                              const socket = io(SERVER_URL, { transports: ["websocket"] });
                                                                                                                                                                  const hudRoomId = document.getElementById("roomId");
                                                                                                                                                                      const hudPlayerCount = document.getElementById("playerCount");
                                                                                                                                                                          const hudCheckpoint = document.getElementById("checkpoint");
                                                                                                                                                                              const centerBanner = document.getElementById("centerBanner");
                                                                                                                                                                                  const resetBtn = document.getElementById("resetBtn");
                                                                                                                                                                                  
                                                                                                                                                                                      socket.on("room-info", ({roomId, players}) => {
                                                                                                                                                                                            hudRoomId.textContent = roomId;
                                                                                                                                                                                                  hudPlayerCount.textContent = players.length;
                                                                                                                                                                                                      });
                                                                                                                                                                                                          socket.on("player-update", (payload) => {
                                                                                                                                                                                                                const { id, pos, vel, checkpoint, name } = payload;
                                                                                                                                                                                                                      let ghost = ghosts.get(id);
                                                                                                                                                                                                                            if (!ghost) {
                                                                                                                                                                                                                                    ghost = makeGhost(name);
                                                                                                                                                                                                                                            ghosts.set(id, ghost);
                                                                                                                                                                                                                                                  }
                                                                                                                                                                                                                                                        ghost.mesh.position.set(pos.x, pos.y, pos.z);
                                                                                                                                                                                                                                                              ghost.name = name;
                                                                                                                                                                                                                                                                    ghost.checkpoint = checkpoint;
                                                                                                                                                                                                                                                                        });
                                                                                                                                                                                                                                                                            socket.on("game-over", ({ winner, name }) => {
                                                                                                                                                                                                                                                                                  state.gameOver = true;
                                                                                                                                                                                                                                                                                        centerBanner.textContent = `${name} wins!`;
                                                                                                                                                                                                                                                                                              centerBanner.style.display = "block";
                                                                                                                                                                                                                                                                                                  });
                                                                                                                                                                                                                                                                                                      socket.on("reset", () => {
                                                                                                                                                                                                                                                                                                            state.gameOver = false;
                                                                                                                                                                                                                                                                                                                  centerBanner.style.display = "none";
                                                                                                                                                                                                                                                                                                                        respawnAtCheckpoint();
                                                                                                                                                                                                                                                                                                                            });
                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                resetBtn.onclick = () => socket.emit("reset");
                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                    // ===== THREE SETUP =====
                                                                                                                                                                                                                                                                                                                                        const scene = new THREE.Scene();
                                                                                                                                                                                                                                                                                                                                            scene.background = new THREE.Color(0x111122);
                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                const camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 1000);
                                                                                                                                                                                                                                                                                                                                                    camera.position.set(0, 10, 16);
                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                        const renderer = new THREE.WebGLRenderer({ antialias:true });
                                                                                                                                                                                                                                                                                                                                                            renderer.setSize(innerWidth, innerHeight);
                                                                                                                                                                                                                                                                                                                                                                document.body.appendChild(renderer.domElement);
                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                    const hemi = new THREE.HemisphereLight(0xffffff, 0x222233, 1.0);
                                                                                                                                                                                                                                                                                                                                                                        scene.add(hemi);
                                                                                                                                                                                                                                                                                                                                                                            const dir = new THREE.DirectionalLight(0xffffff, 0.8);
                                                                                                                                                                                                                                                                                                                                                                                dir.position.set(10,20,10);
                                                                                                                                                                                                                                                                                                                                                                                    scene.add(dir);
                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                        const controls = new OrbitControls(camera, renderer.domElement);
                                                                                                                                                                                                                                                                                                                                                                                            controls.enablePan = false;
                                                                                                                                                                                                                                                                                                                                                                                                controls.enableRotate = false; // locked; we’ll use follow camera
                                                                                                                                                                                                                                                                                                                                                                                                    controls.enableZoom = false;
                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                        // ===== MATERIALS =====
                                                                                                                                                                                                                                                                                                                                                                                                            const mats = {
                                                                                                                                                                                                                                                                                                                                                                                                                  red: new THREE.MeshStandardMaterial({ color: 0xff4d4d, roughness:0.6 }),
                                                                                                                                                                                                                                                                                                                                                                                                                        green: new THREE.MeshStandardMaterial({ color: 0x4dff88, roughness:0.6 }),
                                                                                                                                                                                                                                                                                                                                                                                                                              blue: new THREE.MeshStandardMaterial({ color: 0x4db8ff, roughness:0.6 }),
                                                                                                                                                                                                                                                                                                                                                                                                                                    yellow: new THREE.MeshStandardMaterial({ color: 0xfff04d, roughness:0.6 }),
                                                                                                                                                                                                                                                                                                                                                                                                                                          purple: new THREE.MeshStandardMaterial({ color: 0xc04dff, roughness:0.6 }),
                                                                                                                                                                                                                                                                                                                                                                                                                                                gray: new THREE.MeshStandardMaterial({ color: 0x888899, roughness:0.8 }),
                                                                                                                                                                                                                                                                                                                                                                                                                                                      pad: new THREE.MeshStandardMaterial({ color: 0x00ffff, emissive:0x004444 }),
                                                                                                                                                                                                                                                                                                                                                                                                                                                          };
                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                              // ===== LEVEL =====
                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const colliders = [];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                      const dynamics = [];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const pads = [];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const disappearers = [];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const checkpoints = [];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      let finishTrigger;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const ground = makeBox(50,1,50, mats.gray);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ground.position.set(0,-0.5,0);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  colliders.push(ground);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      scene.add(ground);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          // Start platform + checkpoint 0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const start = makeBox(6,0.5,6, mats.blue);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  start.position.set(0,0,0);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      colliders.push(start); scene.add(start);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          checkpoints.push(start);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              // Rotating beam section
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const beamPivot = new THREE.Object3D();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      beamPivot.position.set(0,2,-10);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          scene.add(beamPivot);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const beam = makeBox(20,0.5,1, mats.red);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  beam.position.set(0,0,0);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      beamPivot.add(beam);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          dynamics.push({ type:"rotate", obj: beamPivot, speed: 0.9 });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const midPlatform = makeBox(5,0.5,5, mats.green);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  midPlatform.position.set(0,0,-20);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      colliders.push(midPlatform); scene.add(midPlatform);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          checkpoints.push(midPlatform);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              // Disappearing platforms path
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  for (let i=0;i<6;i++){
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const p = makeBox(3,0.5,3, mats.yellow);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              p.position.set(-12 + i*4, 0, -30);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    colliders.push(p); scene.add(p);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          disappearers.push({ obj:p, tOffset: i*0.35 });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  // Speed pads ramp
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      for (let i=0;i<3;i++){
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const pad = makeBox(3,0.3,3, mats.pad);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  pad.position.set(10 + i*4, 0, -40);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        pads.push(pad); scene.add(pad);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const ramp = makeBox(12,0.5,18, mats.purple);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ramp.rotation.x = -Math.PI/10;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ramp.position.set(18,0,-50);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            colliders.push(ramp); scene.add(ramp);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                // Finish platform + trigger
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const finish = makeBox(6,0.5,6, mats.green);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        finish.position.set(20,1,-68);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            colliders.push(finish); scene.add(finish);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                finishTrigger = new THREE.Box3().setFromObject(finish);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // ===== PLAYER =====
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const player = makeBox(1,2,1, mats.blue);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            player.position.copy(start.position).add(new THREE.Vector3(0,2,0));
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                scene.add(player);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const ghosts = new Map(); // other players
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        function makeGhost(name="Ghost"){
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const g = makeBox(1,2,1, mats.red);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    g.position.set(0,2,0);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          scene.add(g);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                return { mesh: g, name, checkpoint: 0 };
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        // ===== INPUTS =====
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const keys = {};
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                addEventListener("keydown", (e)=>{ keys[e.code]=true; });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    addEventListener("keyup", (e)=>{ keys[e.code]=false; });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        function updateInputs(){
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              state.inputs.f = !!(keys["KeyW"] || keys["ArrowUp"]);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    state.inputs.b = !!(keys["KeyS"] || keys["ArrowDown"]);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          state.inputs.l = !!(keys["KeyA"] || keys["ArrowLeft"]);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                state.inputs.r = !!(keys["KeyD"] || keys["ArrowRight"]);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      state.inputs.j = !!keys["Space"];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              // ===== PHYSICS LOOP =====
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  let last = performance.now();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      let syncAccum = 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          let disappearTimer = 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              function respawnAtCheckpoint(){
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const cp = checkpoints[state.checkpoint] || start;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          player.position.copy(cp.position).add(new THREE.Vector3(0,2,0));
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                state.vel.set(0,0,0);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      hudCheckpoint.textContent = state.checkpoint;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              function loop(now){
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const dt = Math.min((now - last)/1000, 0.05);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          last = now;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if (state.gameOver) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        renderer.render(scene, camera);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                requestAnimationFrame(loop);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // Dynamics: rotate beams
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          dynamics.forEach(d=>{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  if (d.type==="rotate") d.obj.rotation.y += d.speed*dt;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              // Disappearing platforms toggle
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    disappearTimer += dt;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          disappearers.forEach((d)=>{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const phase = (disappearTimer + d.tOffset) % (2*DISAPPEAR_INTERVAL);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const visible = phase < DISAPPEAR_INTERVAL;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  d.obj.visible = visible;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              updateInputs();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // Movement input
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const dir = new THREE.Vector3(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  (state.inputs.r?1:0) - (state.inputs.l?1:0),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          0,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  (state.inputs.b?1:0) - (state.inputs.f?1:0)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ).normalize();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const forward = new THREE.Vector3(0,0,-1); // world forward
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const right = new THREE.Vector3(1,0,0);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const move = new THREE.Vector3()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  .addScaledVector(forward, dir.z)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          .addScaledVector(right, dir.x)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  .multiplyScalar(PLAYER_SPEED);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        // Apply speed pad if touching
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              let onPad = false;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    pads.forEach(p=>{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const box = new THREE.Box3().setFromObject(p);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (box.containsPoint(player.position)) onPad = true;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if (onPad) move.multiplyScalar(SPEED_PAD_MULT);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      state.vel.x = move.x;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            state.vel.z = move.z;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  // Gravity and jump
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        state.vel.y -= GRAVITY * dt;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              if (state.grounded && state.inputs.j) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      state.vel.y = JUMP_FORCE;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              state.grounded = false;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          // Integrate
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                player.position.addScaledVector(state.vel, dt);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      // Collision (simple AABB with colliders)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            state.grounded = false;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  colliders.forEach(c=>{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          if (!c.visible) return;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const box = new THREE.Box3().setFromObject(c);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          if (box.containsPoint(player.position)) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // Push player up onto the platform top
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              player.position.y = box.max.y + 1.0; // half player height ~1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        state.vel.y = 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  state.grounded = true;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            // Checkpoints: if platform is a checkpoint, update
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      const idx = checkpoints.indexOf(c);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if (idx >= 0 && idx > state.checkpoint) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            state.checkpoint = idx;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        hudCheckpoint.textContent = state.checkpoint;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      // Fall reset
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (player.position.y < -10) respawnAtCheckpoint();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  // Finish check
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const pBox = new THREE.Box3().setFromCenterAndSize(player.position, new THREE.Vector3(1,2,1));
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              if (finishTrigger && pBox.intersectsBox(finishTrigger)) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      socket.emit("win", { name: state.name });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  // Camera follow
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        camera.position.lerp(new THREE.Vector3(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                player.position.x + 0,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        player.position.y + 6,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                player.position.z + 12
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ), 0.08);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            camera.lookAt(player.position);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  // Sync to server
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        syncAccum += dt;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              if (syncAccum >= SYNC_RATE_MS/1000) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      syncAccum = 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              socket.emit("player-update", {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        pos: { x: player.position.x, y: player.position.y, z: player.position.z },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  vel: { x: state.vel.x, y: state.vel.y, z: state.vel.z },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            checkpoint: state.checkpoint,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      name: state.name
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          renderer.render(scene, camera);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                requestAnimationFrame(loop);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        requestAnimationFrame(loop);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            // ===== HELPERS =====
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                function makeBox(w,h,d, mat){
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      const geo = new THREE.BoxGeometry(w,h,d);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const mesh = new THREE.Mesh(geo, mat);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  mesh.castShadow = true;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        mesh.receiveShadow = true;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              return mesh;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      // Responsive
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          addEventListener("resize", ()=>{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                camera.aspect = innerWidth/innerHeight;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      camera.updateProjectionMatrix();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            renderer.setSize(innerWidth, innerHeight);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </script>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </body>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </html>-->